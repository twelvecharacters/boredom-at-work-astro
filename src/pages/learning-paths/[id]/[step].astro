---
import { getCollection, render } from 'astro:content';
import DocLayout from '../../../layouts/DocLayout.astro';
import Roadmap from '../../../components/Roadmap.astro';
import { LEARNING_PATHS } from '../../../data/learning-paths';

export async function getStaticPaths() {
  const paths = [];
  
  for (const path of LEARNING_PATHS) {
    for (const step of path.steps) {
      paths.push({
        params: { id: path.id, step: step.slug },
        props: { path, stepSlug: step.slug },
      });
    }
  }
  
  return paths;
}

const { path, stepSlug } = Astro.props;

// Find the content
const allPosts = await getCollection('blog');
const post = allPosts.find(p => p.id === stepSlug);

if (!post) {
  throw new Error(`Post with slug "${stepSlug}" not found for path "${path.id}".`);
}

const { Content } = await render(post);
const currentStepIndex = path.steps.findIndex(s => s.slug === stepSlug);
const nextStep = path.steps[currentStepIndex + 1];
---

<DocLayout title={post.data.title} pathTitle={path.title} currentStep={stepSlug}>
  <div slot="sidebar" class="space-y-1">
    <a href={`/learning-paths/${path.id}/`} class="doc-nav-item font-bold mb-4 flex items-center gap-2">
        â† Overview
    </a>
    {path.steps.map((s, index) => (
      <a 
        href={`/learning-paths/${path.id}/${s.slug}/`} 
        class={`doc-nav-item ${s.slug === stepSlug ? 'active' : ''}`}
      >
        <span class="opacity-30 mr-2">{index + 1}.</span> {s.title}
      </a>
    ))}
  </div>

  <Content />

  <hr class="my-16 border-gray-100" />

  <Roadmap pathId={path.id} currentSlug={stepSlug} />

  {nextStep && (
    <div class="bg-gray-900 p-8 rounded-2xl text-white mt-8 flex items-center justify-between">
      <div>
        <h3 class="text-white text-lg font-bold mb-1">Module Completed?</h3>
        <p class="text-gray-400 mb-0">Next up: <strong>{nextStep.title}</strong></p>
      </div>
      <a href={`/learning-paths/${path.id}/${nextStep.slug}/`} class="bg-white text-gray-900 px-6 py-3 rounded-xl font-bold hover:bg-gray-100 transition-colors">
        Continue â†’
      </a>
    </div>
  )}

  {!nextStep && (
    <div class="bg-green-600 p-8 rounded-2xl text-white mt-8 text-center">
        <h3 class="text-white text-2xl font-bold mb-2">Congratulations! ğŸ‰</h3>
        <p class="text-green-100 mb-6">You have completed the "{path.title}" learning path.</p>
        <a href="/learning-paths/" class="inline-block bg-white text-green-600 px-8 py-3 rounded-xl font-bold hover:bg-green-50 transition-colors">
            Explore More Paths
        </a>
    </div>
  )}
</DocLayout>
