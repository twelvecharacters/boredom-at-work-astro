---
import { getCollection, render } from 'astro:content';
import DocLayout from '../../../layouts/DocLayout.astro';
import Roadmap from '../../../components/Roadmap.astro';
import { LEARNING_PATHS } from '../../../data/learning-paths';

export async function getStaticPaths() {
  const paths = [];
  
  for (const path of LEARNING_PATHS) {
    for (const step of path.steps) {
      paths.push({
        params: { id: path.id, step: step.slug },
        props: { path, stepSlug: step.slug },
      });
    }
  }
  
  return paths;
}

const { path, stepSlug } = Astro.props;

// Find the content
const allPosts = await getCollection('blog');
const post = allPosts.find(p => p.id === stepSlug);

if (!post) {
  throw new Error(`Post with slug "${stepSlug}" not found for path "${path.id}".`);
}

const { Content } = await render(post);
const currentStepIndex = path.steps.findIndex(s => s.slug === stepSlug);
const nextStep = path.steps[currentStepIndex + 1];
---

<DocLayout title={post.data.title} pathTitle={path.title} currentStep={stepSlug}>
  <div slot="sidebar" class="space-y-1">
    <a href={`/learning-paths/${path.id}/`} class="doc-nav-item font-bold mb-4 flex items-center gap-2">
        ‚Üê Overview
    </a>
    {path.steps.map((s, index) => (
      <a 
        href={`/learning-paths/${path.id}/${s.slug}/`} 
        class={`doc-nav-item ${s.slug === stepSlug ? 'active' : ''}`}
      >
        <span class="opacity-30 mr-2">{index + 1}.</span> {s.title}
      </a>
    ))}
  </div>

  <Content />

  <hr class="my-16 border-gray-100" />

  <Roadmap pathId={path.id} currentSlug={stepSlug} />

  {nextStep && (
    <div class="bg-gray-100 border border-gray-200 p-8 rounded-xl mt-8 flex items-center justify-between">
      <div>
        <h3 class="text-gray-900 text-base font-bold mb-1">Module Processed</h3>
        <p class="text-gray-500 text-sm mb-0">Next Reference: <strong>{nextStep.title}</strong></p>
      </div>
      <a href={`/learning-paths/${path.id}/${nextStep.slug}/`} class="bg-gray-900 text-white px-6 py-2 rounded-lg font-bold hover:bg-gray-800 transition-colors text-xs uppercase tracking-widest">
        Next Entry
      </a>
    </div>
  )}

  {!nextStep && (
    <div class="bg-gray-50 border border-dashed border-gray-300 p-10 rounded-xl mt-8 text-center">
        <h3 class="text-gray-900 text-xl font-bold mb-2">Cycle Complete</h3>
        <p class="text-gray-500 text-sm mb-6 max-w-md mx-auto">All modules in the "{path.title}" reference series have been reviewed. Return to index for further documentation.</p>
        <a href="/learning-paths/" class="inline-block bg-white border border-gray-300 text-gray-700 px-8 py-3 rounded-lg font-bold hover:bg-gray-50 transition-colors text-xs uppercase tracking-widest">
            Return to Index
        </a>
    </div>
  )}
</DocLayout>
