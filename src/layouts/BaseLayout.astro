---
import '../styles/app.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ReadingProgressBar from '../components/ReadingProgressBar.astro';
import ScrollToTop from '../components/ScrollToTop.astro';
import { SEO } from 'astro-seo';
import { SITE } from '../config';

interface Props {
  title: string;
  description?: string;
  image?: string;
  article?: boolean;
  preloadHero?: boolean;
  publishDate?: Date;
  updatedDate?: Date;
  tags?: string[];
  noindex?: boolean;
  prevUrl?: string;
  nextUrl?: string;
}

const {
  title,
  description = SITE.description,
  image = "/images/og-default.webp",
  article = false,
  preloadHero = false,
  publishDate,
  updatedDate,
  tags = [],
  noindex = false,
  prevUrl,
  nextUrl,
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const socialImageURL = new URL(image, Astro.site);
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Preload self-hosted fonts for fastest rendering -->
    <link rel="preload" href="/fonts/inter-latin.woff2" as="font" type="font/woff2" crossorigin />
    <link rel="preload" href="/fonts/outfit-latin.woff2" as="font" type="font/woff2" crossorigin />

    <!-- Preload critical assets -->
    <link rel="preload" href="/images/logo.webp" as="image" type="image/webp" />

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="theme-color" content="#11153b" />
    <link rel="canonical" href={canonicalURL} />

    {preloadHero && (
      <>
        <link rel="preload" as="image" href="/images/hero-background-mobile.webp" media="(max-width: 768px)" type="image/webp" />
        <link rel="preload" as="image" href="/images/hero-background.webp" media="(min-width: 769px)" type="image/webp" />
      </>
    )}

    <SEO
      title={`${title} | ${SITE.title}`}
      description={description}
      canonical={canonicalURL.toString()}
      noindex={noindex}
      openGraph={{
        basic: {
          title: title,
          type: article ? "article" : "website",
          image: socialImageURL.toString(),
          url: canonicalURL.toString(),
        },
        optional: {
          siteName: SITE.title,
          description: description,
        },
        image: {
          width: 1200,
          height: 630,
          type: "image/webp",
        },
        article: article ? {
          publishedTime: publishDate?.toISOString(),
          modifiedTime: (updatedDate || publishDate)?.toISOString(),
          authors: [SITE.author],
          tags: tags,
        } : undefined
      }}
      twitter={{
        card: "summary_large_image",
        title: title,
        description: description,
        image: socialImageURL.toString(),
      }}
      extend={{
        meta: [
          { name: "author", content: SITE.author },
          { name: "generator", content: Astro.generator },
        ],
      }}
    />

    <!-- Schema.org JSON-LD -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": SITE.title,
      "url": new URL('/', Astro.site).toString(),
      "description": SITE.description,
      "logo": new URL('/images/logo.webp', Astro.site).toString(),
      "sameAs": [
        "https://www.youtube.com/@boredom-at-work",
        "https://www.linkedin.com/company/boredom-at-work",
        "https://www.reddit.com/r/boredom_at_work/",
        "https://medium.com/@mohammadmehdivazirian",
        "https://dev.to/twelvecharacters"
      ]
    })} />

    <meta name="generator" content={Astro.generator} />

    {prevUrl && <link rel="prev" href={new URL(prevUrl, Astro.site).toString()} />}
    {nextUrl && <link rel="next" href={new URL(nextUrl, Astro.site).toString()} />}

    <!-- Critical inline CSS for above-the-fold content -->
    <style>
      body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
      header{position:sticky;top:0;z-index:50;background:linear-gradient(to right,#1a1a2e,#16213e)}
      .flex{display:flex}.items-center{align-items:center}.justify-between{justify-content:space-between}
      .py-3{padding-top:.75rem;padding-bottom:.75rem}.px-4{padding-left:1rem;padding-right:1rem}
      .max-w-6xl{max-width:72rem}.mx-auto{margin-left:auto;margin-right:auto}
      .text-white{color:#fff}.font-bold{font-weight:700}
      .h-12{height:3rem}.w-auto{width:auto}
      @media(min-width:768px){.md\:h-14{height:3.5rem}}
    </style>
  </head>
  <body class="min-h-screen flex flex-col">
    {article && <ReadingProgressBar />}
    <Header />
    <main class="flex-grow">
      <slot />
    </main>
    <Footer />

    <!-- Table responsiveness helper -->
    <script>
      function setupResponsiveTables() {
        const tables = document.querySelectorAll('.prose table');
        tables.forEach(table => {
          const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent?.trim());
          if (headers.length > 0) {
            table.setAttribute('data-has-labels', 'true');
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
              const cells = row.querySelectorAll('td');
              cells.forEach((cell, index) => {
                if (headers[index]) {
                  cell.setAttribute('data-label', headers[index]);
                }
              });
            });
          }
        });
      }

      // Run on load and after swaps if using View Transitions
      window.addEventListener('load', setupResponsiveTables);
      document.addEventListener('astro:page-load', setupResponsiveTables);
    </script>

    <!-- Google Analytics 4 - Deferred loading -->
    <script>
      // Load GA on first user interaction or after 5s (whichever comes first)
      (function() {
        var loaded = false;
        function loadGA() {
          if (loaded) return;
          loaded = true;
          var script = document.createElement('script');
          script.src = 'https://www.googletagmanager.com/gtag/js?id=GT-PL3RVFQX';
          script.async = true;
          document.head.appendChild(script);

          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          window.gtag = gtag;
          gtag('js', new Date());
          gtag('config', 'GT-PL3RVFQX');
        }
        ['scroll', 'click', 'touchstart', 'keydown'].forEach(function(evt) {
          window.addEventListener(evt, loadGA, { once: true, passive: true });
        });
        setTimeout(loadGA, 5000);
      })();
    </script>
    <ScrollToTop />
  </body>
</html>
