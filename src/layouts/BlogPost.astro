---
import BaseLayout from './BaseLayout.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import OptimizedImage from '../components/OptimizedImage.astro';
import FaqSchema from '../components/FaqSchema.astro';
import TableOfContents from '../components/TableOfContents.astro';
import SocialShare from '../components/SocialShare.astro';
import { SITE } from '../config';
import { getPostSlug } from '../utils/blog';
import type { CollectionEntry } from 'astro:content';

interface Props {
  post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const { title, description, publishDate, updatedDate, author, image, tags, faq } = post.data;

// Calculate reading time (average 200 words per minute)
const content = post.body || '';
const wordCount = content.split(/\s+/).filter(word => word.length > 0).length;
const readingTime = Math.max(1, Math.ceil(wordCount / 200));

// Breadcrumb items
const breadcrumbItems = [
  { name: 'Blog', url: '/blog/' },
  { name: title, url: `/${getPostSlug(post)}/` }
];

const formattedDate = publishDate.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

const formattedUpdatedDate = updatedDate?.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---

<BaseLayout title={title} description={description} image={image} article={true}>
  <article class="max-w-4xl mx-auto px-4 py-8">
    <!-- Breadcrumbs -->
    <Breadcrumbs items={breadcrumbItems} />

    <!-- Article Header -->
    <header class="mb-8">
      <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-primary mb-4 leading-tight">
        {title}
      </h1>

      <div class="flex flex-wrap items-center gap-4 text-text-light text-sm mb-6">
        <span>By {author}</span>
        <span>•</span>
        <time datetime={publishDate.toISOString()}>{formattedDate}</time>
        <span>•</span>
        <span>{readingTime} min read</span>
        {updatedDate && (
          <div class="flex items-center text-accent font-medium bg-accent/5 px-2 py-0.5 rounded ml-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            <span>Updated: {formattedUpdatedDate}</span>
          </div>
        )}
      </div>

      {tags.length > 0 && (
        <div class="flex flex-wrap gap-2 mb-6">
          {tags.map(tag => (
            <span class="bg-background-alt text-text-light px-3 py-1 rounded-full text-sm">
              {tag}
            </span>
          ))}
        </div>
      )}

      <!-- Intro text before image for better SEO -->
      <p class="text-lg text-text-light leading-relaxed mb-6">
        {description}
      </p>

      {image && (
        <OptimizedImage
          src={image}
          alt={title}
          class="w-full rounded-xl shadow-lg"
        />
      )}
    </header>

    <!-- Table of Contents -->
    <TableOfContents />

    <!-- Article Content -->
    <div class="prose" data-pagefind-body>
      <slot />
    </div>

    <!-- Social Share Buttons -->
    <SocialShare title={title} description={description} />

    <!-- Related Posts -->
    <RelatedPosts currentSlug={getPostSlug(post)} currentTags={tags} />

    <!-- Article Footer -->
    <footer class="mt-12 pt-8 border-t border-primary/10">
      <div class="bg-background-alt rounded-xl p-6">
        <h3 class="text-lg font-semibold mb-2">Ready to learn more?</h3>
        <p class="text-text-light mb-4">
          Check out our other guides on AI skills, certifications, and productive ways to use your work downtime.
        </p>
        <a href="/blog/" class="btn-primary">
          Browse All Articles
        </a>
      </div>
    </footer>
  </article>

  <!-- Schema.org Article Markup -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": title,
    "description": description,
    "image": image,
    "datePublished": publishDate.toISOString(),
    "dateModified": (updatedDate || publishDate).toISOString(),
    "author": {
      "@type": "Person",
      "name": author
    },
    "publisher": {
      "@type": "Organization",
      "name": SITE.title
    }
  })} />

  {faq && faq.length > 0 && <FaqSchema faqs={faq} />}
</BaseLayout>
